# ==============================================================================
# AZALSCORE - Configuration Render.com BETA
# ==============================================================================
# Deploiement automatique sur Render (plateforme gratuite selectionnee)
#
# CARACTERISTIQUES:
# - HTTPS automatique
# - Redemarrage automatique
# - PostgreSQL gratuit (90 jours)
# - Region EU (Frankfurt) pour conformite RGPD
# - Zero cout
#
# VARIABLES REQUISES (configurer dans Render Dashboard > Environment):
# ---------------------------------------------------------------------
# SECRET_KEY         - Cle JWT (min 32 chars, pas de valeur faible)
#                      Generer: python -c "import secrets; print(secrets.token_urlsafe(64))"
# BOOTSTRAP_SECRET   - Secret bootstrap (min 32 chars)
#                      Generer: python -c "import secrets; print(secrets.token_urlsafe(64))"
# ENCRYPTION_KEY     - Cle Fernet pour chiffrement AES-256
#                      Generer: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
# CORS_ORIGINS       - URL frontend (ex: https://azalscore-frontend.onrender.com)
# ADMIN_EMAIL        - Email administrateur initial
# ADMIN_PASSWORD     - Mot de passe admin (min 12 chars, pas de valeur faible)
#
# ==============================================================================

services:
  # ==========================================================================
  # API BACKEND (FastAPI)
  # ==========================================================================
  - type: web
    name: azalscore-api
    runtime: python
    region: frankfurt
    plan: free  # Gratuit pour BETA

    # Build et demarrage
    buildCommand: |
      pip install -r requirements.txt
      python -c "
      from app.db.base import Base
      from sqlalchemy import create_engine
      import os
      engine = create_engine(os.environ['DATABASE_URL'])
      Base.metadata.create_all(bind=engine)
      print('Database tables created')
      "

    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2

    # Health Check
    healthCheckPath: /health

    # Variables d'environnement
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.7"
      - key: DEBUG
        value: "false"
      - key: ENVIRONMENT
        value: "staging"  # Mode staging pour BETA (moins de contraintes)
      - key: LOG_LEVEL
        value: "INFO"
      # Secrets (configurer dans Dashboard)
      - key: SECRET_KEY
        sync: false
      - key: BOOTSTRAP_SECRET
        sync: false
      - key: ENCRYPTION_KEY
        sync: false
      - key: CORS_ORIGINS
        sync: false
      - key: ADMIN_EMAIL
        sync: false
      - key: ADMIN_PASSWORD
        sync: false
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: azalscore-db
          property: connectionString

    # Auto-deploy
    autoDeploy: true

  # ==========================================================================
  # FRONTEND (React + Vite)
  # ==========================================================================
  - type: web
    name: azalscore-frontend
    runtime: static
    region: frankfurt
    plan: free

    # Build
    buildCommand: cd frontend && npm ci && npm run build
    staticPublishPath: frontend/dist

    # Routes SPA
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    # Headers de securite
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin

    # Variables
    envVars:
      - key: VITE_API_URL
        value: https://azalscore-api.onrender.com
      - key: NODE_VERSION
        value: "18"

    autoDeploy: true

# ==============================================================================
# BASE DE DONNEES
# ==============================================================================
databases:
  - name: azalscore-db
    region: frankfurt
    plan: free  # Gratuit 90 jours, puis limite
    databaseName: azalscore
    user: azalscore_user
    ipAllowList: []  # Uniquement services Render (securite)
