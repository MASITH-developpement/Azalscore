# ==============================================================================
# AZALSCORE - Docker Compose Portable
# ==============================================================================
# Configuration multi-plateforme, zero dependance cloud.
# Compatible: Linux, macOS (Intel/ARM), Windows (Docker Desktop)
#
# USAGE:
#   docker compose -f docker-compose.portable.yml up -d
#
# ==============================================================================

version: '3.8'

services:
  # ==========================================================================
  # BASE DE DONNEES
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: azals-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-azals}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD requis}
      POSTGRES_DB: ${POSTGRES_DB:-azalscore}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - azals-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-azals}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M

  # ==========================================================================
  # CACHE REDIS
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: azals-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - azals-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 64M

  # ==========================================================================
  # API BACKEND
  # ==========================================================================
  api:
    build:
      context: ..
      dockerfile: Dockerfile.prod
    container_name: azals-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Base
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DEBUG: ${DEBUG:-false}

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-azals}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-azalscore}

      # Security
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY requis}
      BOOTSTRAP_SECRET: ${BOOTSTRAP_SECRET:?BOOTSTRAP_SECRET requis}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?ENCRYPTION_KEY requis}
      MASTER_ENCRYPTION_KEY: ${MASTER_ENCRYPTION_KEY:-${ENCRYPTION_KEY}}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost,http://localhost:5173}

      # Redis
      REDIS_URL: redis://redis:6379/0

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - api_data:/app/data
      - api_logs:/app/logs
    networks:
      - azals-internal
      - azals-external
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # ==========================================================================
  # FRONTEND
  # ==========================================================================
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.prod
    container_name: azals-frontend
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - azals-external
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

  # ==========================================================================
  # REVERSE PROXY
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: azals-nginx
    restart: unless-stopped
    depends_on:
      - api
      - frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - azals-external
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

  # ==========================================================================
  # BACKUP SCHEDULER (optionnel)
  # ==========================================================================
  backup:
    image: alpine:latest
    container_name: azals-backup
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-azals}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-azalscore}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    volumes:
      - backup_data:/backups
      - ./scripts/backup-cron.sh:/backup.sh:ro
    networks:
      - azals-internal
    command: |
      sh -c '
        apk add --no-cache postgresql-client gzip
        echo "0 2 * * * /backup.sh" | crontab -
        crond -f
      '
    deploy:
      resources:
        limits:
          memory: 128M

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  postgres_data:
    name: azals-postgres-data
  redis_data:
    name: azals-redis-data
  api_data:
    name: azals-api-data
  api_logs:
    name: azals-api-logs
  nginx_logs:
    name: azals-nginx-logs
  backup_data:
    name: azals-backups

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  azals-internal:
    name: azals-internal
    internal: true
  azals-external:
    name: azals-external
