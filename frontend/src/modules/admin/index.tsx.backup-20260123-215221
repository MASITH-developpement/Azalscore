import React, { useState } from 'react';
import { Routes, Route, useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { api } from '@core/api-client';
import { PageWrapper, Card, Grid } from '@ui/layout';
import { DataTable } from '@ui/tables';
import { Button, Modal } from '@ui/actions';
import { Select, Input } from '@ui/forms';
import { StatCard } from '@ui/dashboards';
import { BaseViewStandard } from '@ui/standards';
import { PermissionsManager } from '@ui/simple';
import type { TabDefinition, InfoBarItem, SidebarSection, ActionDefinition } from '@ui/standards';
import {
  Users, Building, Shield, Database, Activity, AlertTriangle,
  User, Key, Clock, Sparkles, ArrowLeft, Edit3, Lock, Unlock
} from 'lucide-react';
import type { TableColumn } from '@/types';
import type { AdminUser, Role } from './types';
import {
  USER_STATUS_CONFIG, getUserFullName, isUserActive, isUserLocked,
  hasTwoFactorEnabled, mustChangePassword, formatDateTime
} from './types';
import {
  UserInfoTab, UserPermissionsTab, UserActivityTab,
  UserHistoryTab, UserIATab
} from './components';

// ============================================================================
// LOCAL COMPONENTS
// ============================================================================

const Badge: React.FC<{ color: string; children: React.ReactNode }> = ({ color, children }) => (
  <span className={`azals-badge azals-badge--${color}`}>{children}</span>
);

interface TabNavProps {
  tabs: { id: string; label: string }[];
  activeTab: string;
  onChange: (id: string) => void;
}

const TabNav: React.FC<TabNavProps> = ({ tabs, activeTab, onChange }) => (
  <nav className="azals-tab-nav">
    {tabs.map((tab) => (
      <button
        key={tab.id}
        className={`azals-tab-nav__item ${activeTab === tab.id ? 'azals-tab-nav__item--active' : ''}`}
        onClick={() => onChange(tab.id)}
      >
        {tab.label}
      </button>
    ))}
  </nav>
);

// ============================================================================
// TYPES INTERNES
// ============================================================================

interface User {
  id: string;
  username: string;
  email: string;
  first_name?: string;
  last_name?: string;
  role_id?: string;
  role_name?: string;
  status: 'ACTIVE' | 'INACTIVE' | 'SUSPENDED' | 'PENDING';
  last_login?: string;
  created_at: string;
}

interface Tenant {
  id: string;
  code: string;
  name: string;
  domain?: string;
  status: 'ACTIVE' | 'INACTIVE' | 'TRIAL' | 'SUSPENDED';
  plan: 'FREE' | 'STARTER' | 'PROFESSIONAL' | 'ENTERPRISE';
  modules_enabled: string[];
  user_count: number;
  storage_used: number;
  created_at: string;
}

interface AuditLog {
  id: string;
  timestamp: string;
  user_id?: string;
  user_name?: string;
  action: string;
  resource_type: string;
  resource_id?: string;
  details?: Record<string, any>;
  ip_address?: string;
  user_agent?: string;
}

interface BackupConfig {
  id: string;
  name: string;
  type: 'FULL' | 'INCREMENTAL' | 'DIFFERENTIAL';
  schedule: string;
  retention_days: number;
  destination: 'LOCAL' | 'S3' | 'GCS' | 'AZURE';
  last_backup?: string;
  last_status?: 'SUCCESS' | 'FAILED' | 'IN_PROGRESS';
  is_active: boolean;
}

interface AdminDashboard {
  total_users: number;
  active_users: number;
  total_tenants: number;
  active_tenants: number;
  total_roles: number;
  storage_used_gb: number;
  api_calls_today: number;
  errors_today: number;
}

// ============================================================================
// CONSTANTES
// ============================================================================

const USER_STATUSES = [
  { value: 'ACTIVE', label: 'Actif', color: 'green' },
  { value: 'INACTIVE', label: 'Inactif', color: 'gray' },
  { value: 'SUSPENDED', label: 'Suspendu', color: 'red' },
  { value: 'PENDING', label: 'En attente', color: 'orange' }
];

const TENANT_STATUSES = [
  { value: 'ACTIVE', label: 'Actif', color: 'green' },
  { value: 'INACTIVE', label: 'Inactif', color: 'gray' },
  { value: 'TRIAL', label: 'Essai', color: 'blue' },
  { value: 'SUSPENDED', label: 'Suspendu', color: 'red' }
];

const TENANT_PLANS = [
  { value: 'FREE', label: 'Gratuit' },
  { value: 'STARTER', label: 'Starter' },
  { value: 'PROFESSIONAL', label: 'Professionnel' },
  { value: 'ENTERPRISE', label: 'Enterprise' }
];

const BACKUP_TYPES = [
  { value: 'FULL', label: 'Complete' },
  { value: 'INCREMENTAL', label: 'Incrementale' },
  { value: 'DIFFERENTIAL', label: 'Differentielle' }
];

const BACKUP_DESTINATIONS = [
  { value: 'LOCAL', label: 'Local' },
  { value: 'S3', label: 'AWS S3' },
  { value: 'GCS', label: 'Google Cloud' },
  { value: 'AZURE', label: 'Azure Blob' }
];

// ============================================================================
// HELPERS
// ============================================================================

const formatDate = (date: string): string => {
  return new Date(date).toLocaleDateString('fr-FR');
};

const formatDateTimeFn = (date: string): string => {
  return new Date(date).toLocaleString('fr-FR');
};

const getStatusInfo = (statuses: any[], status: string) => {
  return statuses.find(s => s.value === status) || { label: status, color: 'gray' };
};

const formatBytes = (bytes: number): string => {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
};

// ============================================================================
// API HOOKS
// ============================================================================

const useAdminDashboard = () => {
  return useQuery({
    queryKey: ['admin', 'dashboard'],
    queryFn: async () => {
      try {
        return await api.get<AdminDashboard>('/v1/admin/dashboard', {
          headers: { 'X-Silent-Error': 'true' }
        }).then(r => r.data);
      } catch {
        // Retourner des valeurs par dÃ©faut si l'endpoint n'existe pas
        return {
          total_users: 0,
          active_users: 0,
          total_tenants: 1,
          active_tenants: 1,
          total_roles: 0,
          storage_used_gb: 0,
          api_calls_today: 0,
          errors_today: 0
        };
      }
    },
    retry: false
  });
};

const useUsers = (filters?: { status?: string; role_id?: string }) => {
  return useQuery({
    queryKey: ['admin', 'users', filters],
    queryFn: async () => {
      try {
        const params = new URLSearchParams();
        if (filters?.status) params.append('is_active', filters.status === 'active' ? 'true' : 'false');
        if (filters?.role_id) params.append('role_code', filters.role_id);
        const queryString = params.toString();
        const res = await api.get<{ items: User[]; total: number }>(`/v1/iam/users${queryString ? `?${queryString}` : ''}`, {
          headers: { 'X-Silent-Error': 'true' }
        });
        return res.data.items || [];
      } catch {
        return [];
      }
    },
    retry: false
  });
};

const useUser = (id: string | undefined) => {
  return useQuery({
    queryKey: ['admin', 'user', id],
    queryFn: async () => {
      try {
        return await api.get<AdminUser>(`/v1/iam/users/${id}`, {
          headers: { 'X-Silent-Error': 'true' }
        }).then(r => r.data);
      } catch {
        return null;
      }
    },
    enabled: !!id,
    retry: false
  });
};

const useRoles = () => {
  return useQuery({
    queryKey: ['admin', 'roles'],
    queryFn: async () => {
      try {
        return await api.get<Role[]>('/v1/iam/roles', {
          headers: { 'X-Silent-Error': 'true' }
        }).then(r => r.data);
      } catch {
        return []; // Retourne liste vide si pas de permission
      }
    },
    retry: false
  });
};

const useTenants = (filters?: { status?: string; plan?: string }) => {
  return useQuery({
    queryKey: ['admin', 'tenants', filters],
    queryFn: async () => {
      return api.get<Tenant[]>('/v1/tenants').then(r => r.data);
    }
  });
};

const useAuditLogs = (filters?: { resource_type?: string }) => {
  return useQuery({
    queryKey: ['admin', 'audit-logs', filters],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (filters?.resource_type) params.append('resource_type', filters.resource_type);
      const queryString = params.toString();
      return api.get<AuditLog[]>(`/v1/audit/logs${queryString ? `?${queryString}` : ''}`).then(r => r.data);
    }
  });
};

const useBackupConfigs = () => {
  return useQuery({
    queryKey: ['admin', 'backups'],
    queryFn: async () => {
      return api.get<BackupConfig[]>('/v1/backup/config').then(r => r.data);
    }
  });
};

const useCreateUser = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (data: Partial<User> & { password: string }) => {
      return api.post('/v1/admin/users', data).then(r => r.data);
    },
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['admin', 'users'] })
  });
};

const useUpdateUserStatus = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ id, status }: { id: string; status: string }) => {
      return api.patch(`/v1/admin/users/${id}`, { status }).then(r => r.data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin', 'users'] });
      queryClient.invalidateQueries({ queryKey: ['admin', 'user'] });
    }
  });
};

const useRunBackup = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (id: string) => {
      return api.post(`/v1/backup/${id}/run`).then(r => r.data);
    },
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['admin', 'backups'] })
  });
};

// ============================================================================
// USER DETAIL VIEW (BaseViewStandard)
// ============================================================================

const UserDetailView: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: user, isLoading, error } = useUser(id);
  const updateStatus = useUpdateUserStatus();

  if (isLoading) {
    return (
      <PageWrapper title="Chargement..." subtitle="Utilisateur">
        <div className="azals-loading">Chargement...</div>
      </PageWrapper>
    );
  }

  if (error || !user) {
    return (
      <PageWrapper title="Erreur" subtitle="Utilisateur non trouve">
        <Card>
          <p className="text-red-600">Impossible de charger l'utilisateur</p>
          <Button onClick={() => navigate('/admin')} className="mt-4">Retour</Button>
        </Card>
      </PageWrapper>
    );
  }

  const statusConfig = USER_STATUS_CONFIG[user.status];

  const tabs: TabDefinition<AdminUser>[] = [
    { id: 'info', label: 'Informations', icon: <User size={16} />, component: UserInfoTab },
    { id: 'permissions', label: 'Permissions', icon: <Shield size={16} />, component: UserPermissionsTab },
    { id: 'activity', label: 'Activite', icon: <Activity size={16} />, component: UserActivityTab, badge: user.sessions?.filter(s => s.is_active).length },
    { id: 'history', label: 'Historique', icon: <Clock size={16} />, component: UserHistoryTab },
    { id: 'ia', label: 'Assistant IA', icon: <Sparkles size={16} />, component: UserIATab }
  ];

  const infoBarItems: InfoBarItem[] = [
    {
      id: 'status',
      label: 'Statut',
      value: statusConfig.label,
      valueColor: statusConfig.color
    },
    {
      id: 'role',
      label: 'Role',
      value: user.role_name || 'Non assigne',
      valueColor: user.role_name ? 'purple' : 'gray'
    },
    {
      id: '2fa',
      label: '2FA',
      value: hasTwoFactorEnabled(user) ? 'Active' : 'Desactive',
      valueColor: hasTwoFactorEnabled(user) ? 'green' : 'orange'
    },
    {
      id: 'logins',
      label: 'Connexions',
      value: String(user.login_count),
      valueColor: 'blue'
    }
  ];

  const sidebarSections: SidebarSection[] = [
    {
      id: 'security',
      title: 'Securite',
      items: [
        { id: 'status', label: 'Statut', value: statusConfig.label },
        { id: '2fa', label: 'Double authentification', value: hasTwoFactorEnabled(user) ? 'Oui' : 'Non' },
        { id: 'pwd', label: 'Changement MDP requis', value: mustChangePassword(user) ? 'Oui' : 'Non' },
        { id: 'failures', label: 'Echecs de connexion', value: String(user.failed_login_count) }
      ]
    },
    {
      id: 'activity',
      title: 'Activite',
      items: [
        { id: 'logins', label: 'Connexions totales', value: String(user.login_count) },
        { id: 'last', label: 'Derniere connexion', value: user.last_login ? formatDateTime(user.last_login) : 'Jamais' },
        { id: 'sessions', label: 'Sessions actives', value: String(user.sessions?.filter(s => s.is_active).length || 0) }
      ]
    },
    {
      id: 'dates',
      title: 'Dates',
      items: [
        { id: 'created', label: 'Creation', value: formatDateTime(user.created_at) },
        { id: 'updated', label: 'Modification', value: formatDateTime(user.updated_at) }
      ]
    }
  ];

  const headerActions: ActionDefinition[] = [
    {
      id: 'back',
      label: 'Retour',
      icon: <ArrowLeft size={16} />,
      variant: 'secondary',
      onClick: () => navigate('/admin')
    },
    {
      id: 'edit',
      label: 'Modifier',
      icon: <Edit3 size={16} />,
      variant: 'secondary',
      onClick: () => console.log('Edit user')
    }
  ];

  const primaryActions: ActionDefinition[] = isUserLocked(user)
    ? [
        {
          id: 'unlock',
          label: 'Debloquer',
          icon: <Unlock size={16} />,
          variant: 'primary',
          onClick: () => updateStatus.mutate({ id: user.id, status: 'ACTIVE' })
        }
      ]
    : [];

  const secondaryActions: ActionDefinition[] = !isUserLocked(user) && isUserActive(user)
    ? [
        {
          id: 'suspend',
          label: 'Suspendre',
          icon: <Lock size={16} />,
          variant: 'danger',
          onClick: () => updateStatus.mutate({ id: user.id, status: 'SUSPENDED' })
        }
      ]
    : [];

  return (
    <BaseViewStandard<AdminUser>
      title={getUserFullName(user)}
      subtitle={`@${user.username}`}
      status={{ label: statusConfig.label, color: statusConfig.color }}
      data={user}
      view="detail"
      tabs={tabs}
      infoBarItems={infoBarItems}
      sidebarSections={sidebarSections}
      headerActions={headerActions}
      primaryActions={primaryActions}
      secondaryActions={secondaryActions}
    />
  );
};

// ============================================================================
// COMPOSANTS LISTE
// ============================================================================

const UsersView: React.FC = () => {
  const navigate = useNavigate();
  const [filterStatus, setFilterStatus] = useState<string>('');
  const [filterRole, setFilterRole] = useState<string>('');
  const { data: users = [], isLoading } = useUsers({
    status: filterStatus || undefined,
    role_id: filterRole || undefined
  });
  const { data: roles = [] } = useRoles();
  const createUser = useCreateUser();
  const updateStatus = useUpdateUserStatus();
  const [showModal, setShowModal] = useState(false);
  const [formData, setFormData] = useState<Partial<User> & { password: string }>({ password: '' });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    await createUser.mutateAsync(formData);
    setShowModal(false);
    setFormData({ password: '' });
  };

  const handleRowClick = (user: User) => {
    navigate(`/admin/users/${user.id}`);
  };

  const columns: TableColumn<User>[] = [
    { id: 'username', header: 'Utilisateur', accessor: 'username' },
    { id: 'email', header: 'Email', accessor: 'email' },
    { id: 'last_name', header: 'Nom', accessor: 'last_name', render: (v, row) =>
      `${(row as User).first_name || ''} ${(row as User).last_name || ''}`.trim() || '-'
    },
    { id: 'role_name', header: 'Role', accessor: 'role_name', render: (v) => (v as string) || '-' },
    { id: 'last_login', header: 'Derniere connexion', accessor: 'last_login', render: (v) => (v as string) ? formatDateTimeFn(v as string) : 'Jamais' },
    { id: 'status', header: 'Statut', accessor: 'status', render: (v, row) => (
      <div onClick={(e) => e.stopPropagation()}>
        <Select
          value={v as string}
          onChange={(val) => {
            updateStatus.mutate({ id: (row as User).id, status: val });
          }}
          options={USER_STATUSES}
          className="w-32"
        />
      </div>
    )}
  ];

  return (
    <Card>
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">Utilisateurs</h3>
        <div className="flex gap-2">
          <Select
            value={filterRole}
            onChange={(val) => setFilterRole(val)}
            options={[{ value: '', label: 'Tous les roles' }, ...roles.map(r => ({ value: r.id, label: r.name }))]}
            className="w-40"
          />
          <Select
            value={filterStatus}
            onChange={(val) => setFilterStatus(val)}
            options={[{ value: '', label: 'Tous statuts' }, ...USER_STATUSES]}
            className="w-32"
          />
          <Button onClick={() => setShowModal(true)}>Nouvel utilisateur</Button>
        </div>
      </div>
      <DataTable
        columns={columns}
        data={users}
        isLoading={isLoading}
        keyField="id"
        onRowClick={handleRowClick}
      />

      <Modal isOpen={showModal} onClose={() => setShowModal(false)} title="Nouvel utilisateur">
        <form onSubmit={handleSubmit}>
          <Grid cols={2}>
            <div className="azals-field">
              <label>Prenom</label>
              <Input
                value={formData.first_name || ''}
                onChange={(v) => setFormData({ ...formData, first_name: v })}
              />
            </div>
            <div className="azals-field">
              <label>Nom</label>
              <Input
                value={formData.last_name || ''}
                onChange={(v) => setFormData({ ...formData, last_name: v })}
              />
            </div>
          </Grid>
          <Grid cols={2}>
            <div className="azals-field">
              <label>Nom d'utilisateur</label>
              <Input
                value={formData.username || ''}
                onChange={(v) => setFormData({ ...formData, username: v })}
              />
            </div>
            <div className="azals-field">
              <label>Email</label>
              <Input
                type="email"
                value={formData.email || ''}
                onChange={(v) => setFormData({ ...formData, email: v })}
              />
            </div>
          </Grid>
          <Grid cols={2}>
            <div className="azals-field">
              <label>Mot de passe</label>
              <Input
                type="password"
                value={formData.password}
                onChange={(v) => setFormData({ ...formData, password: v })}
              />
            </div>
            <div className="azals-field">
              <label>Role</label>
              <Select
                value={formData.role_id || ''}
                onChange={(val) => setFormData({ ...formData, role_id: val })}
                options={[{ value: '', label: 'Selectionner...' }, ...roles.map(r => ({ value: r.id, label: r.name }))]}
              />
            </div>
          </Grid>
          <div className="flex justify-end gap-2 mt-4">
            <Button variant="secondary" onClick={() => setShowModal(false)}>Annuler</Button>
            <Button type="submit" isLoading={createUser.isPending}>Creer</Button>
          </div>
        </form>
      </Modal>
    </Card>
  );
};

const RolesView: React.FC = () => {
  const { data: roles = [], isLoading } = useRoles();

  const columns: TableColumn<Role>[] = [
    { id: 'code', header: 'Code', accessor: 'code', render: (v) => <code className="font-mono">{v as string}</code> },
    { id: 'name', header: 'Nom', accessor: 'name' },
    { id: 'description', header: 'Description', accessor: 'description', render: (v) => (v as string) || '-' },
    { id: 'permissions', header: 'Permissions', accessor: 'permissions', render: (v) => <Badge color="purple">{(v as string[])?.length || 0}</Badge> },
    { id: 'user_count', header: 'Utilisateurs', accessor: 'user_count', render: (v) => <Badge color="blue">{v as number}</Badge> },
    { id: 'is_system', header: 'Systeme', accessor: 'is_system', render: (v) => (
      <Badge color={(v as boolean) ? 'orange' : 'gray'}>{(v as boolean) ? 'Oui' : 'Non'}</Badge>
    )}
  ];

  return (
    <Card>
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">Roles</h3>
        <Button>Nouveau role</Button>
      </div>
      <DataTable columns={columns} data={roles} isLoading={isLoading} keyField="id" />
    </Card>
  );
};

const TenantsView: React.FC = () => {
  const [filterStatus, setFilterStatus] = useState<string>('');
  const [filterPlan, setFilterPlan] = useState<string>('');
  const { data: tenants = [], isLoading } = useTenants({
    status: filterStatus || undefined,
    plan: filterPlan || undefined
  });

  const columns: TableColumn<Tenant>[] = [
    { id: 'code', header: 'Code', accessor: 'code', render: (v) => <code className="font-mono">{v as string}</code> },
    { id: 'name', header: 'Nom', accessor: 'name' },
    { id: 'domain', header: 'Domaine', accessor: 'domain', render: (v) => (v as string) || '-' },
    { id: 'plan', header: 'Plan', accessor: 'plan', render: (v) => {
      const info = TENANT_PLANS.find(p => p.value === (v as string));
      return <Badge color="blue">{info?.label || (v as string)}</Badge>;
    }},
    { id: 'user_count', header: 'Utilisateurs', accessor: 'user_count' },
    { id: 'storage_used', header: 'Stockage', accessor: 'storage_used', render: (v) => formatBytes(v as number) },
    { id: 'status', header: 'Statut', accessor: 'status', render: (v) => {
      const info = getStatusInfo(TENANT_STATUSES, v as string);
      return <Badge color={info.color as any}>{info.label}</Badge>;
    }}
  ];

  return (
    <Card>
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">Tenants</h3>
        <div className="flex gap-2">
          <Select
            value={filterPlan}
            onChange={(val) => setFilterPlan(val)}
            options={[{ value: '', label: 'Tous les plans' }, ...TENANT_PLANS]}
            className="w-36"
          />
          <Select
            value={filterStatus}
            onChange={(val) => setFilterStatus(val)}
            options={[{ value: '', label: 'Tous statuts' }, ...TENANT_STATUSES]}
            className="w-32"
          />
          <Button>Nouveau tenant</Button>
        </div>
      </div>
      <DataTable columns={columns} data={tenants} isLoading={isLoading} keyField="id" />
    </Card>
  );
};

const AuditView: React.FC = () => {
  const [filterType, setFilterType] = useState<string>('');
  const { data: logs = [], isLoading } = useAuditLogs({
    resource_type: filterType || undefined
  });

  const resourceTypes = [...new Set(logs.map(l => l.resource_type))].map(t => ({ value: t, label: t }));

  const columns: TableColumn<AuditLog>[] = [
    { id: 'timestamp', header: 'Date', accessor: 'timestamp', render: (v) => formatDateTimeFn(v as string) },
    { id: 'user_name', header: 'Utilisateur', accessor: 'user_name', render: (v) => (v as string) || 'Systeme' },
    { id: 'action', header: 'Action', accessor: 'action' },
    { id: 'resource_type', header: 'Type', accessor: 'resource_type', render: (v) => <Badge color="blue">{v as string}</Badge> },
    { id: 'resource_id', header: 'ID Ressource', accessor: 'resource_id', render: (v) => (v as string) ? <code className="font-mono text-xs">{v as string}</code> : '-' },
    { id: 'ip_address', header: 'IP', accessor: 'ip_address', render: (v) => (v as string) || '-' }
  ];

  return (
    <Card>
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">Journal d'audit</h3>
        <Select
          value={filterType}
          onChange={(val) => setFilterType(val)}
          options={[{ value: '', label: 'Tous les types' }, ...resourceTypes]}
          className="w-48"
        />
      </div>
      <DataTable columns={columns} data={logs} isLoading={isLoading} keyField="id" />
    </Card>
  );
};

const BackupsView: React.FC = () => {
  const { data: backups = [], isLoading } = useBackupConfigs();
  const runBackup = useRunBackup();

  const columns: TableColumn<BackupConfig>[] = [
    { id: 'name', header: 'Nom', accessor: 'name' },
    { id: 'type', header: 'Type', accessor: 'type', render: (v) => {
      const info = BACKUP_TYPES.find(t => t.value === (v as string));
      return info?.label || (v as string);
    }},
    { id: 'schedule', header: 'Planification', accessor: 'schedule' },
    { id: 'destination', header: 'Destination', accessor: 'destination', render: (v) => {
      const info = BACKUP_DESTINATIONS.find(d => d.value === (v as string));
      return info?.label || (v as string);
    }},
    { id: 'retention_days', header: 'Retention', accessor: 'retention_days', render: (v) => `${v as number} jours` },
    { id: 'last_backup', header: 'Derniere', accessor: 'last_backup', render: (v) => (v as string) ? formatDateTimeFn(v as string) : '-' },
    { id: 'last_status', header: 'Statut', accessor: 'last_status', render: (v) => {
      if (!v) return '-';
      const colors: Record<string, string> = { SUCCESS: 'green', FAILED: 'red', IN_PROGRESS: 'orange' };
      return <Badge color={(colors[v as string] || 'gray') as any}>{v as string}</Badge>;
    }},
    { id: 'actions', header: 'Actions', accessor: 'id', render: (v, row) => (
      (row as BackupConfig).is_active ? (
        <Button size="sm" onClick={() => runBackup.mutate((row as BackupConfig).id)}>Lancer</Button>
      ) : null
    )}
  ];

  return (
    <Card>
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">Sauvegardes</h3>
        <Button>Nouvelle config</Button>
      </div>
      <DataTable columns={columns} data={backups} isLoading={isLoading} keyField="id" />
    </Card>
  );
};

// ============================================================================
// MODULE PRINCIPAL
// ============================================================================

type View = 'dashboard' | 'users' | 'permissions' | 'roles' | 'tenants' | 'audit' | 'backups';

const AdminDashboardView: React.FC = () => {
  const [currentView, setCurrentView] = useState<View>('dashboard');
  const { data: dashboard } = useAdminDashboard();

  const tabs = [
    { id: 'dashboard', label: 'Tableau de bord' },
    { id: 'users', label: 'Utilisateurs' },
    { id: 'permissions', label: 'Permissions' },
    { id: 'roles', label: 'Roles' },
    { id: 'tenants', label: 'Tenants' },
    { id: 'audit', label: 'Audit' },
    { id: 'backups', label: 'Sauvegardes' }
  ];

  const renderContent = () => {
    switch (currentView) {
      case 'users':
        return <UsersView />;
      case 'permissions':
        return <PermissionsManager />;
      case 'roles':
        return <RolesView />;
      case 'tenants':
        return <TenantsView />;
      case 'audit':
        return <AuditView />;
      case 'backups':
        return <BackupsView />;
      default:
        return (
          <div className="space-y-4">
            <Grid cols={4}>
              <StatCard
                title="Utilisateurs actifs"
                value={`${dashboard?.active_users || 0} / ${dashboard?.total_users || 0}`}
                icon={<Users size={20} />}
                variant="default"
                onClick={() => setCurrentView('users')}
              />
              <StatCard
                title="Tenants actifs"
                value={`${dashboard?.active_tenants || 0} / ${dashboard?.total_tenants || 0}`}
                icon={<Building size={20} />}
                variant="default"
                onClick={() => setCurrentView('tenants')}
              />
              <StatCard
                title="Roles"
                value={String(dashboard?.total_roles || 0)}
                icon={<Shield size={20} />}
                variant="success"
                onClick={() => setCurrentView('roles')}
              />
              <StatCard
                title="Stockage utilise"
                value={`${dashboard?.storage_used_gb || 0} GB`}
                icon={<Database size={20} />}
                variant="warning"
              />
            </Grid>
            <Grid cols={2}>
              <StatCard
                title="Appels API (aujourd'hui)"
                value={String(dashboard?.api_calls_today || 0)}
                icon={<Activity size={20} />}
                variant="default"
              />
              <StatCard
                title="Erreurs (aujourd'hui)"
                value={String(dashboard?.errors_today || 0)}
                icon={<AlertTriangle size={20} />}
                variant={dashboard?.errors_today ? 'danger' : 'success'}
                onClick={() => setCurrentView('audit')}
              />
            </Grid>
          </div>
        );
    }
  };

  return (
    <PageWrapper title="Administration" subtitle="Gestion des utilisateurs, roles et systeme">
      <TabNav
        tabs={tabs}
        activeTab={currentView}
        onChange={(id) => setCurrentView(id as View)}
      />
      <div className="mt-4">
        {renderContent()}
      </div>
    </PageWrapper>
  );
};

const AdminModule: React.FC = () => {
  return (
    <Routes>
      <Route path="users/:id" element={<UserDetailView />} />
      <Route path="*" element={<AdminDashboardView />} />
    </Routes>
  );
};

export default AdminModule;
