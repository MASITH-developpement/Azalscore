# ============================================================================
# AZALSCORE - GitHub Actions CI/CD
# ============================================================================
# 
# Ce workflow exécute les tests automatiquement à chaque push/PR.
# 
# Fichier à placer dans: .github/workflows/test.yml
#
# ============================================================================

name: Tests AZALSCORE

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  DATABASE_URL: 'sqlite:///:memory:'
  SECRET_KEY: 'test-secret-key-for-ci'
  ENCRYPTION_KEY: 'test-encryption-key-32char!'
  STRIPE_API_KEY_LIVE: 'sk_test_fake'
  STRIPE_WEBHOOK_SECRET: 'whsec_test_fake'
  RESEND_API_KEY: 're_test_fake'

jobs:
  # ========================================================================
  # TESTS UNITAIRES
  # ========================================================================
  unit-tests:
    name: Tests Unitaires
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements_test.txt

      - name: Run unit tests
        run: |
          pytest tests/test_signup_service.py \
                 tests/test_tenant_guard.py \
                 tests/test_email_service.py \
                 -v --tb=short

  # ========================================================================
  # TESTS API
  # ========================================================================
  api-tests:
    name: Tests API
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements_test.txt

      - name: Run API tests
        run: |
          pytest tests/test_signup_router.py \
                 tests/test_stripe_webhooks.py \
                 -v --tb=short

  # ========================================================================
  # TESTS E2E
  # ========================================================================
  e2e-tests:
    name: Tests End-to-End
    runs-on: ubuntu-latest
    needs: [unit-tests, api-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements_test.txt

      - name: Run E2E tests
        run: |
          pytest tests/test_e2e.py -v --tb=short

  # ========================================================================
  # COUVERTURE DE CODE
  # ========================================================================
  coverage:
    name: Couverture de Code
    runs-on: ubuntu-latest
    needs: [unit-tests, api-tests, e2e-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements_test.txt

      - name: Run tests with coverage
        run: |
          pytest tests/ \
                 --cov=app \
                 --cov-report=xml \
                 --cov-report=term-missing \
                 --cov-fail-under=70

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ========================================================================
  # LINT & SÉCURITÉ
  # ========================================================================
  lint:
    name: Lint & Sécurité
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: |
          pip install ruff bandit safety

      - name: Run Ruff (linter)
        run: ruff check app/
        continue-on-error: true

      - name: Run Bandit (security)
        run: bandit -r app/ -ll
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        run: safety check -r requirements.txt
        continue-on-error: true

  # ========================================================================
  # BUILD DOCKER
  # ========================================================================
  docker-build:
    name: Build Docker
    runs-on: ubuntu-latest
    needs: [unit-tests, api-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t azalscore:test .

      - name: Run container health check
        run: |
          docker run -d --name azalscore-test \
            -e DATABASE_URL=sqlite:///:memory: \
            -e SECRET_KEY=test \
            -p 8000:8000 \
            azalscore:test
          
          sleep 10
          
          curl -f http://localhost:8000/health/live || exit 1
          
          docker stop azalscore-test
